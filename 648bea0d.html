<!DOCTYPE html>
<html ng-app="ionicApp">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width" />
    <title>ROKI_FANS</title>
    <link href="//code.ionicframework.com/1.0.0-beta.13/css/ionic.css" rel="stylesheet">
    <style>
        #debug {
            margin-top:44px;
            background-color: white;
            height: 300px;
            overflow: scroll;
            color: black;
            font-size: 12px;
        }
        #debug p {
            padding: 3px 5px;
            word-wrap: break-word;
        }
        .gray {
            background-color: #ddd;
        }
        #debug span {
            display: block;
            word-wrap: break-word;
            margin-bottom: 2px;
        }
    </style>
</head>
<body>
    <div class="bar bar-header bar-assertive">
      <h1 class="title" id="device_id"></h1>
  </div>
  <div id="debug"></div>

  <div class="bar-footer" style="bottom:0;position:absolute;width:100%">
     <div class="item item-input-inset">
       <label class="item-input-wrapper">
         <input type="text" placeholder="message" id="message">
     </label>
     <button class="button button-small button-royal" id="send2uart">
         Uart
     </button>
 </div>

 <div class="button-bar">
     <a class="button" style="background:red; color:white" id="led_red">Light</a>
     <a class="button" style="background:green; color:white" id="led_green">Èõ</a>
     <a class="button" style="background:blue; color:white" id="led_blue">±¬</a>
 </div>
 <div class="button-bar">
     <a class="button" style="background:white; color:black" id="led_on">On</a>
     <a class="button" style="background:black; color:white" id="led_off">Off</a>
 </div>
</div>

<script src="http://api.easylink.io/assets/js/mqttws31.js"></script>
<script>
    // ä»urlä¸­è·å–æŸä¸ªå‚æ•°çš„å€¼
    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }
    // å¾—åˆ°è®¾å¤‡ID
    var device_id = getParameterByName('device_id');
    // å¦‚æœè®¾å¤‡IDä¸ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œè¿æ¥MQTTçš„æ“ä½œ
    if ( device_id !== null ){
        ez_connect(device_id);
    }

    // function dump_obj(myObject) {
    //     var s = '';
    //     for (var property in myObject) {
    //         s += '<span>' + property +": " + myObject[property] + '</span>';
    //     }
    //     return s;
    // }

    // è¿æ¥MQTTæœåŠ¡
    function ez_connect(device_id) {
        // è·å–access_token
        // access_tokenæ˜¯å…¬ä¼—å·çš„å…¨å±€å”¯ä¸€ç¥¨æ®ï¼Œå…¬ä¼—å·è°ƒç”¨å„æ¥å£æ—¶éƒ½éœ€ä½¿ç”¨access_tokenã€‚
        // æ­£å¸¸æƒ…å†µä¸‹access_tokenæœ‰æ•ˆæœŸä¸º7200ç§’ï¼Œé‡å¤è·å–å°†å¯¼è‡´ä¸Šæ¬¡è·å–çš„access_tokenå¤±æ•ˆ
        var access_token = getParameterByName('access_token');

        document.getElementById('device_id').innerHTML = device_id;

        // websocketè¿æ¥
        // wsbroker:host
        // wsport:ç«¯å£ é»˜è®¤1983
        // Client-ID ï¼š v1_web_[MAC]  //ç‰ˆæœ¬å·_app_æ‰‹æœºMAC(å¿…é¡»æ˜¯12ä½å°å†™)
        var wsbroker = "api.easylink.io";  //mqtt websocket enabled broker
        var wsport = 1983 // port for above
        var client = new Paho.MQTT.Client(wsbroker, wsport, "v1-web-" + parseInt(Math.random() * 1000000, 12));

        // åŸºæœ¬å‚æ•°é…ç½®
        // è¿æ¥ä¸¢å¤±æ‰€å¯¹åº”çš„callbackå‡½æ•°
        client.onConnectionLost = onConnectionLost;
        // æ¶ˆæ¯åˆ°è¾¾æ‰€å¯¹åº”çš„callbackå‡½æ•°
        client.onMessageArrived = onMessageArrived;
        // è¿æ¥æˆåŠŸæ‰€å¯¹åº”çš„callbackå‡½æ•°
        client.connect({onSuccess:onConnect});

        // è¿æ¥æˆåŠŸ
        function onConnect() {
            var subtopic = device_id+'/out/#';
            // Once a connection has been made, make a subscription and send a message.
            // å‘æŸä¸ªé€šé“å‘é€æŒ‡ä»¤
            // topicï¼šé€šé“
            // commondï¼šæŒ‡ä»¤
            client.publish = function(topic, commond) {
                console.log("ç°åœ¨æ‰§è¡Œ-->:"+commond);
                message = new Paho.MQTT.Message(commond);
                message.destinationName = topic;
                client.send(message);
            }
            console.log("device_id:"+device_id);
            console.log("onConnect");
            client.subscribe(subtopic, {qos: 0});
        }
        // è¿æ¥ä¸¢å¤±
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0)
                console.log("onConnectionLost:"+responseObject.errorMessage);
        }
        // æ¶ˆæ¯åˆ°è¾¾
        function onMessageArrived(message) {
            console.log(message.topic + ': ' +  message.payloadString);
        }

        // ä¸²å£æ•°æ®å‘é€éƒ¨åˆ†
        var inputMessage = document.getElementById('message');
        // å°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šçš„é€šé“
        function send2uart() {
            if ( inputMessage.value.length == 0 ) return;
            var topic = device_id+'/in/write';
            var commond = '{"11":"' + inputMessage.value + '"}';
            client.publish(topic, commond);
            console.log(inputMessage.value);
            inputMessage.value = '';
        }
        // document.querySelector('#send2uart').addEventListener('touchstart', send2uart);
        document.querySelector('#send2uart').addEventListener('click', send2uart);

        function led_on() {
            var topic = device_id+'/in/write';
            var commond = '{"rgbled_switch":true}';
            client.publish(topic, commond);
        }
        // document.querySelector('#led_on').addEventListener('touchstart', led_on);
        document.querySelector('#led_on').addEventListener('click', led_on);

        function led_off() {
            var topic = device_id+'/in/write';
            var commond = '{"rgbled_switch":false}';
            client.publish(topic, commond);
        }
        // document.querySelector('#led_off').addEventListener('touchstart', led_off);
        document.querySelector('#led_off').addEventListener('click', led_off);

        function led_red() {
            var topic = device_id+'/in/write';
            var commond = '{"rgbled_switch":true,"rgbled_hues":0, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
        // document.querySelector('#led_red').addEventListener('touchstart', led_red);
        document.querySelector('#led_red').addEventListener('click', led_red);

        function led_green() {
            var topic = device_id+'/in/write';
            var commond = '{"rgbled_switch":true,"rgbled_hues":120, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
        // document.querySelector('#led_green').addEventListener('touchstart', led_green);
        document.querySelector('#led_green').addEventListener('click', led_green);

        function led_blue() {
            var topic = device_id+'/in/write';
            var commond = '{"rgbled_switch":true,"rgbled_hues":240, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
        // document.querySelector('#led_blue').addEventListener('touchstart', led_blue);
        document.querySelector('#led_blue').addEventListener('click', led_blue);
    }

    // æ—¥å¿—æ‰“å°åœ¨é¡µé¢çš„éƒ¨åˆ†    
    var i = 0;
    console.log = (function(old_funct, div_log) {
        return function(text) {
            old_funct(text);
            var p = '';
            if (i%2 == 0)
                p = '<p>';
            else
                p = '<p class=\'gray\'>';

            if (typeof text === "object")
                div_log.innerHTML += p + JSON.stringify(text) + '</p>';
            else
                div_log.innerHTML += p + text + '</p>';

            div_log.scrollTop = div_log.scrollHeight;
            i += 1;
        };
    } (console.log.bind(console), document.getElementById("debug")));
    console.error = console.debug = console.info =  console.log;

</script>
</body>
</html>
